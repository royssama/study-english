<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>영어 단어 학습</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link href="./styles.css?v03" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1 class="header-title"><div class="header-icon"></div>영어 단어 학습</h1>
        <!-- 시작 화면 -->
        <div id="startScreen">
            <div class="start-container">
                <h2>영어 단어 학습</h2>
                <div class="how_use_it"><i class="fas fa-circle-question"></i>
                    <div>
                        사용방법: 1.GPT APP이나 사이트로 이동.  2.GPT에게 등록할 단어 이미지(아래 show sample image 참고) 업로드. 
                        3.아래 프롬프트 클릭(클립보드 복사) 후 GPT 프롬프트 창에 입력.
                        <br>
                        
                        <span class="how_use_it_span_copy" title="copy"><i class="fas fa-copy"></i> 업로드한 이미지에서 영문단어,문장설명,한글뜻 을 찾아서  JSON 형식으로 변환해줘, 단 첫번째 컬럼은 영문단어, 두번째 컬럼은 문장설명, 세번째 컬럼은 한글뜻 으로 만들어줘.
                        </span>
                        <br>
                        4.만들어낸 JSON 형식을 복사해서 아래 붙여넣기.  5.단어 등록 버튼 클릭.
                        <div style="display: flex; gap: 10px;">
                            <div class="sample_image" id="sample_image">
                                <i class="fas fa-image"></i> show sample image.
                            </div>
                            <div class="sample_json_data" id="sample_json_data">
                                <i class="fas fa-copy"></i> copy sample json data.
                            </div>
                        </div>
                        <div id="sampleJsonData" style="display: none;">
[
  {
    "word": "time",
    "definition": "This is what you look at when you want to know what hour it is.",
    "korean": "시간"
  },
  {
    "word": "watch",
    "definition": "You wear this on your wrist to keep track of the time.",
    "korean": "시계"
  },
  {
    "word": "banana",
    "definition": "A long yellow fruit that monkeys love to eat.",
    "korean": "바나나"
  },
  {
    "word": "phone",
    "definition": "A device you use to make calls, send messages, or browse the internet.",
    "korean": "핸드폰"
  },
  {
    "word": "moniter",
    "definition": "A screen you look at when using a computer.",
    "korean": "모니터"
  },
  {
    "word": "flesh",
    "definition": "The soft part of your body that's under your skin and muscles.",
    "korean": "고기"
  },
  {
    "word": "globe",
    "definition": "A model or map of the Earth, usually round and used to study geography.",
    "korean": "지구본"
  },
  {
    "word": "clap",
    "definition": "You do this with your hands when you're happy or cheering for someone.",
    "korean": "박수를 치다"
  },
  {
    "word": "play",
    "definition": "Children and adults both enjoy doing this for fun, often with toys or games.",
    "korean": "놀다"
  },
  {
    "word": "plum",
    "definition": "A small, round, purple fruit that is sweet and juicy.",
    "korean": "자두"
  }
]
                        </div>
                    </div>
                </div>

                <div class="input-section">
                    <div class="textarea-section">
                        <textarea id="wordInputArea" class="word-input" placeholder="JSON 형식으로 단어를 입력하세요:
[
  {
    &quot;english&quot;: &quot;time&quot;,
    &quot;definition&quot;: &quot;This is what you look at when you want to know what hour it is.&quot;,
    &quot;korean&quot;: &quot;시간&quot;
  },
  {
    &quot;english&quot;: &quot;watch&quot;,
    &quot;definition&quot;: &quot;You wear this on your wrist to keep track of the time.&quot;,
    &quot;korean&quot;: &quot;시계&quot;
  }
]"></textarea>
                        <button onclick="addWordsFromText()" class="add-btn">단어 등록</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 퀴즈 섹션 -->
        <div id="quizSection" style="display: none;">
            <div class="quiz-container">
                <div class="question-container">
                    <div class="progress-counters">
                        <span class="counter">
                            <span id="currentQuestion">1</span> 
                            / <span id="totalQuestions">0</span>
                        </span>
                    </div>
                    <div class="progress-counter">
                        <div class="button-group">
                            <button onclick="retryQuiz()" class="retry-btn">다시 풀기</button>
                            <button onclick="startOver()" class="start-over-btn">처음부터 다시하기</button>
                        </div>
                    </div>
                    <h2>정의를 보고 단어를 입력하세요</h2>
                    <div class="definition-box">
                        <p id="definitionText"></p>
                        <div id="exampleContainer" style="display: none;"></div>
                    </div>
                    <div class="answer-inputs">
                        <div class="input-row">
                            <div class="input-group">
                                <label for="englishInput">영어:</label>
                                <input type="text" id="englishInput" placeholder="영어 단어를 입력하세요">
                            </div>
                            <div class="input-group">
                                <label for="koreanInput">한글:</label>
                                <input type="text" id="koreanInput" placeholder="한글 뜻을 입력하세요">
                            </div>
                        </div>
                    </div>
                    <button onclick="checkAnswer()" class="check-btn">정답 확인</button>
                </div>
                <div class="results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>정의</th>
                                <th>영어</th>
                                <th>한글</th>
                                <th>결과</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 정답지 버튼 -->
        <button class="answer-sheet-btn" onclick="toggleAnswerSheet()">
            <i class="fas fa-book"></i>
        </button>

        <!-- 정답지 레이어 -->
        <div class="answer-sheet-layer" id="answerSheetLayer">
            <div class="answer-sheet-content">
                <div class="answer-sheet-header">
                    <h3>정답지</h3>
                    <button class="close-btn" onclick="toggleAnswerSheet()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="scanned-content" id="scannedContent">
                    <table class="answer-sheet-table">
                        <thead>
                            <tr>
                                <th>영어</th>
                                <th>정의</th>
                                <th>한글</th>
                            </tr>
                        </thead>
                        <tbody id="answerSheetTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 샘플 이미지 레이어 -->
        <div class="sample-image-layer" id="sampleImageLayer">
            <div class="sample-image-content">
                <div class="sample-image-header">
                    <h3>샘플 이미지</h3>
                    <button class="close-btn" onclick="toggleSampleImage()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="sample-image-body">
                    <img src="img/10word.png" alt="샘플 이미지">
                </div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let words = []; // 단어 목록
        let currentQuestion = null;
        let currentQuestionIndex = 0;
        let totalQuestions = 0;
        let correctSound = new Audio('sounds/ok.wav');
        let incorrectSound = new Audio('sounds/no.wav');
        let startSound = new Audio('sounds/start.wav');
        let shuffledWords = []; // 섞인 단어 목록을 저장할 변수 추가

        // 단어 등록 함수
        function addWordsFromText() {
            const text = document.getElementById('wordInputArea').value.trim();
            if (!text) {
                showNotification('단어를 입력해주세요.');
                playSound(false); // 오류 사운드 재생
                return;
            }

            try {
                const jsonData = JSON.parse(text);
                if (Array.isArray(jsonData)) {
                    words = jsonData.map(item => {
                        // 객체의 속성들을 배열로 변환
                        const properties = Object.entries(item);
                        
                        // 첫 번째, 두 번째, 세 번째 속성을 각각 영어, 정의, 한글에 매핑
                        return {
                            word: properties[0] ? properties[0][1] : '', // 첫 번째 속성의 값
                            definition: properties[1] ? properties[1][1] : '', // 두 번째 속성의 값
                            korean: properties[2] ? properties[2][1] : '' // 세 번째 속성의 값
                        };
                    }).filter(word => word.word && word.definition && word.korean); // 필수 속성이 모두 있는 경우만 필터링

                    updateAnswerSheet();
                    showNotification('단어가 성공적으로 등록되었습니다.');

                    // 2초 후에 퀴즈 시작
                    setTimeout(() => {
                        startQuiz();
                    }, 2000);
                } else {
                    showNotification('올바른 JSON 형식이 아닙니다.');
                    playSound(false); // 오류 사운드 재생
                }
            } catch (error) {
                showNotification('JSON 형식이 올바르지 않습니다.');
                playSound(false); // 오류 사운드 재생
                console.error('JSON 파싱 오류:', error);
            }
        }

        // 단어 목록 섞기 함수 추가
        function shuffleWords() {
            shuffledWords = [...words];
            for (let i = shuffledWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledWords[i], shuffledWords[j]] = [shuffledWords[j], shuffledWords[i]];
            }
        }

        // 알림 표시 함수
        function showNotification(message, isCorrect = true) {
            const notification = document.createElement('div');
            notification.className = `notification-popup ${isCorrect ? 'correct' : 'incorrect'}`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // 정답지 업데이트 함수
        function updateAnswerSheet() {
            const tableBody = document.getElementById('answerSheetTableBody');
            tableBody.innerHTML = '';

            words.forEach((word, index) => {
                const row = document.createElement('tr');
                // 현재 문제인 경우 하이라이트 클래스 추가
                const isCurrentQuestion = currentQuestion && word.word === currentQuestion.question.word;
                if (isCurrentQuestion) {
                    row.className = 'current-question-row';
                    // 스크롤을 위해 ID 추가
                    row.id = 'current-question-row';
                }
                row.innerHTML = `
                    <td>
                        ${word.word}
                        <button class="speaker-btn" onclick="speakWord('${word.word}')">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </td>
                    <td>${word.definition}</td>
                    <td>${word.korean}</td>
                `;
                tableBody.appendChild(row);
            });

            // 현재 문제 행으로 스크롤
            const currentRow = document.getElementById('current-question-row');
            if (currentRow) {
                currentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 정답지 토글 함수
        function toggleAnswerSheet() {
            const layer = document.getElementById('answerSheetLayer');
            if (layer.style.display === 'none' || layer.style.display === '') {
                layer.style.display = 'block';
                layer.classList.add('active');
                // 현재 문제 업데이트
                updateAnswerSheet();
                // ESC 키 이벤트 리스너 추가
                document.addEventListener('keydown', handleEscKey);
                // 레이어 클릭 이벤트 리스너 추가
                layer.addEventListener('click', handleLayerClick);
            } else {
                closeAnswerSheet();
            }
        }

        // 정답지 닫기 함수 추가
        function closeAnswerSheet() {
            const layer = document.getElementById('answerSheetLayer');
            layer.style.display = 'none';
            layer.classList.remove('active');
            // 이벤트 리스너 제거
            document.removeEventListener('keydown', handleEscKey);
            layer.removeEventListener('click', handleLayerClick);
        }

        // ESC 키 핸들러 함수
        function handleEscKey(event) {
            if (event.key === 'Escape') {
                closeAnswerSheet();
            }
        }

        // 레이어 클릭 핸들러 함수
        function handleLayerClick(event) {
            // 클릭된 요소가 레이어 자체인 경우에만 닫기
            if (event.target === event.currentTarget) {
                closeAnswerSheet();
            }
        }

        // 사운드 재생 함수
        function playSound(isCorrect) {
            try {
                const sound = isCorrect ? correctSound : incorrectSound;
                sound.currentTime = 0;
                sound.play().catch(error => {
                    console.error('사운드 재생 실패:', error);
                    // 사운드 재생 실패 시 대체 알림
                    showNotification(isCorrect ? '정답입니다!' : '오답입니다!');
                });
            } catch (error) {
                console.error('사운드 재생 오류:', error);
                showNotification(isCorrect ? '정답입니다!' : '오답입니다!');
            }
        }

        // 시작 화면 숨기기 함수
        function hideStartScreen() {
            document.getElementById('startScreen').style.display = 'none';
        }

        // 퀴즈 시작 함수 수정
        function startQuiz() {
            if (words.length === 0) {
                alert('단어를 먼저 추가해주세요.');
                return;
            }

            try {
                startSound.currentTime = 0;
                startSound.play().catch(error => {
                    console.error('시작 사운드 재생 실패:', error);
                });
            } catch (error) {
                console.error('시작 사운드 재생 오류:', error);
            }

            hideStartScreen();
            currentQuestionIndex = 0;
            totalQuestions = words.length;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('quizSection').style.display = 'block';
            
            // 단어 목록 섞기
            shuffleWords();
            getQuiz();
        }

        // 퀴즈 문제 가져오기 함수 수정
        function getQuiz() {
            if (currentQuestionIndex < shuffledWords.length) {
                // 랜덤하게 문제 선택
                const randomIndex = Math.floor(Math.random() * shuffledWords.length);
                const currentWord = shuffledWords[randomIndex];
                
                // 선택된 문제를 배열에서 제거하여 중복 방지
                shuffledWords.splice(randomIndex, 1);
                
                currentQuestion = {
                    question: currentWord
                };
                document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
                document.getElementById('totalQuestions').textContent = words.length;
                const definitionText = document.getElementById('definitionText');
                definitionText.textContent = currentWord.definition;
                
                // definition-box에 클릭 이벤트 추가
                const definitionBox = document.querySelector('.definition-box');
                definitionBox.style.cursor = 'pointer';
                definitionBox.onclick = function() {
                    speakWord(definitionText.textContent);
                };
                
                document.getElementById('englishInput').value = '';
                document.getElementById('koreanInput').value = '';
                document.getElementById('englishInput').focus();
                
                // 예문이 있으면 표시하고 스피커 버튼 추가
                const exampleContainer = document.getElementById('exampleContainer');
                if (currentWord.example) {
                    exampleContainer.innerHTML = `
                        <div class="example-sentence">
                            ${currentWord.example}
                            <button class="speaker-btn" onclick="speakWord('${currentWord.example}')">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    `;
                    exampleContainer.style.display = 'block';
                } else {
                    exampleContainer.style.display = 'none';
                }
            }
        }

        // 정답 확인 함수
        function checkAnswer() {
            const englishInput = document.getElementById('englishInput');
            const koreanInput = document.getElementById('koreanInput');
            const englishAnswer = englishInput.value.trim().toLowerCase();
            const koreanAnswer = koreanInput.value.trim();

            if (!englishAnswer && !koreanAnswer) {
                alert('영어와 한글 모두 입력해주세요.');
                englishInput.focus();
                return;
            }

            if (!englishAnswer) {
                alert('영어를 입력해주세요.');
                englishInput.focus();
                return;
            }

            if (!koreanAnswer) {
                alert('한글을 입력해주세요.');
                koreanInput.focus();
                return;
            }

            // 영어 단어만 정확히 일치하는지 확인
            const isCorrect = englishAnswer === currentQuestion.question.word.toLowerCase();

            // 정답/오답 알림 표시 (오답일 경우 빨간색으로 표시)
            showNotification(isCorrect ? '정답입니다!' : '오답입니다!', isCorrect);

            const resultsTableBody = document.getElementById('resultsTableBody');
            const newRow = document.createElement('tr');

            if (isCorrect) {
                playSound(true);
                newRow.innerHTML = `
                    <td>${currentQuestion.question.definition}</td>
                    <td>
                        <div class="correct-answer">${currentQuestion.question.word}</div>
                        <div class="user-answer correct">${englishAnswer}</div>
                    </td>
                    <td>
                        <div class="correct-answer">${currentQuestion.question.korean}</div>
                        <div class="user-answer korean">${koreanAnswer}</div>
                    </td>
                    <td class="result-correct">정답</td>
                `;
            } else {
                playSound(false);
                newRow.innerHTML = `
                    <td>${currentQuestion.question.definition}</td>
                    <td>
                        <div class="correct-answer">${currentQuestion.question.word}</div>
                        <div class="user-answer incorrect">${englishAnswer}</div>
                    </td>
                    <td>
                        <div class="correct-answer">${currentQuestion.question.korean}</div>
                        <div class="user-answer korean">${koreanAnswer}</div>
                    </td>
                    <td class="result-incorrect">오답</td>
                `;
            }

            resultsTableBody.insertBefore(newRow, resultsTableBody.firstChild);
            englishInput.value = '';
            koreanInput.value = '';

            // 결과 테이블 표시
            document.querySelector('.results-table').style.display = 'block';

            // 자동으로 다음 문제로 이동
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < shuffledWords.length) {
                    getQuiz();
                } else {
                    showResultSummary();
                }
            }, 1000);
        }

        // 엔터 키 이벤트 리스너 추가
        document.addEventListener('DOMContentLoaded', function() {
            const englishInput = document.getElementById('englishInput');
            const koreanInput = document.getElementById('koreanInput');

            function handleEnterKey(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    checkAnswer();
                }
            }

            englishInput.addEventListener('keydown', handleEnterKey);
            koreanInput.addEventListener('keydown', handleEnterKey);
        });

        // 결과 요약 표시 함수 추가
        function showResultSummary() {
            const correctAnswers = document.querySelectorAll('.result-correct').length;
            const totalAnswers = words.length;
            
            // 오버레이 생성
            const overlay = document.createElement('div');
            overlay.className = 'result-overlay';
            document.body.appendChild(overlay);
            
            // 결과 요약 생성
            const resultSummary = document.createElement('div');
            resultSummary.className = 'result-summary';
            resultSummary.innerHTML = `
                <h3>퀴즈 결과</h3>
                <p>총 ${totalAnswers}문제 중 ${correctAnswers}문제 정답!</p>
                <div class="result-buttons">
                    <button onclick="retryQuiz()" class="retry-btn">다시 풀기</button>
                    <button onclick="closeQuiz()" class="close-btn">닫기</button>
                </div>
            `;
            
            document.body.appendChild(resultSummary);
            overlay.style.display = 'block';
        }

        // 다시 풀기 함수 수정
        function retryQuiz() {
            const resultSummary = document.querySelector('.result-summary');
            const resultOverlay = document.querySelector('.result-overlay');
            
            if (resultSummary) {
                resultSummary.remove();
            }
            if (resultOverlay) {
                resultOverlay.remove();
            }
            
            currentQuestionIndex = 0;
            document.getElementById('resultsTableBody').innerHTML = '';
            // 단어 목록 다시 섞기
            shuffleWords();
            getQuiz();
        }

        // 퀴즈 닫기 함수 수정
        function closeQuiz() {
            document.querySelector('.result-summary').remove();
            document.querySelector('.result-overlay').remove();
        }

        // 처음부터 다시하기 함수 추가
        function startOver() {
            const resultSummary = document.querySelector('.result-summary');
            const resultOverlay = document.querySelector('.result-overlay');
            
            if (resultSummary) {
                resultSummary.remove();
            }
            if (resultOverlay) {
                resultOverlay.remove();
            }
            
            document.getElementById('quizSection').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('wordInputArea').value = '';
            words = [];
            currentQuestionIndex = 0;
            totalQuestions = 0;
            document.getElementById('resultsTableBody').innerHTML = '';
            document.getElementById('answerSheetTableBody').innerHTML = '';
        }

        function speakWord(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.7; // 속도 조절 (0.1 ~ 10, 기본값 1)
                window.speechSynthesis.speak(utterance);
            } else {
                alert('이 브라우저에서는 음성 기능을 지원하지 않습니다.');
            }
        }

        // Service Worker 등록
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/study-english/templates/sw.js')
                    .then(registration => {
                        // 새로운 Service Worker가 설치되었을 때
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // 새로운 버전이 설치되었음을 알림
                                    if (confirm('새로운 버전이 있습니다. 업데이트하시겠습니까?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker 등록 실패:', error);
                    });
            });
        }

        // 클립보드 복사 기능
        document.querySelector('.how_use_it_span_copy').addEventListener('click', function() {
            const textToCopy = this.textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                showNotification('클립보드에 복사되었습니다!', 'success');
            }).catch(err => {
                showNotification('복사에 실패했습니다.', 'error');
            });
        });

        // 샘플 이미지 토글 함수
        function toggleSampleImage() {
            const layer = document.getElementById('sampleImageLayer');
            if (layer.style.display === 'none' || layer.style.display === '') {
                layer.style.display = 'block';
                layer.classList.add('active');
                // ESC 키 이벤트 리스너 추가
                document.addEventListener('keydown', handleEscKey);
                // 레이어 클릭 이벤트 리스너 추가
                layer.addEventListener('click', handleLayerClick);
            } else {
                closeSampleImage();
            }
        }

        // 샘플 이미지 닫기 함수
        function closeSampleImage() {
            const layer = document.getElementById('sampleImageLayer');
            layer.style.display = 'none';
            layer.classList.remove('active');
            // 이벤트 리스너 제거
            document.removeEventListener('keydown', handleEscKey);
            layer.removeEventListener('click', handleLayerClick);
        }

        // ESC 키 핸들러 함수
        function handleEscKey(event) {
            if (event.key === 'Escape') {
                closeSampleImage();
            }
        }

        // 레이어 클릭 핸들러 함수
        function handleLayerClick(event) {
            // 클릭된 요소가 레이어 자체인 경우에만 닫기
            if (event.target === event.currentTarget) {
                closeSampleImage();
            }
        }

        // 샘플 이미지 클릭 이벤트 리스너 추가
        document.querySelector('.sample_image').addEventListener('click', toggleSampleImage);

        // 샘플 JSON 데이터 클릭 이벤트 리스너 추가
        document.querySelector('.sample_json_data').addEventListener('click', function() {
            const jsonData = document.getElementById('sampleJsonData').textContent;
            navigator.clipboard.writeText(jsonData).then(() => {
                showNotification('JSON 데이터가 클립보드에 복사되었습니다!<br>아래 붙여넣기해서 사용해보세요', 'success');
            }).catch(err => {
                showNotification('복사에 실패했습니다.', 'error');
            });
        });

        // 단어 목록 초기화
        words = [];
        currentQuestion = null;
        currentQuestionIndex = 0;
        totalQuestions = 0;
        shuffledWords = [];
    </script>
</body>
</html> 